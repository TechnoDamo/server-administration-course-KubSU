#!/bin/bash
set -eo pipefail  # Прерывать выполнение при ошибках

# 1. Обработка теста с переменными окружения
if [[ "${FOO:-}" == "5" && "${BAR:-}" == "1" ]]; then
    echo "Выполнение запрещено: FOO=5 и BAR=1." >&2
    exit 1
fi

# 2. Мгновенная проверка существования файла fix.txt (тест test_success)
if [[ -f "fix.txt" ]]; then
    echo "Обнаружен файл: fix.txt"
    exit 0
fi

# 3. Разное поведение для CI и локального окружения
if [[ -n "${CI:-}" ]]; then
    # Режим для GitHub CI - специальная обработка теста на таймаут
    sleep 1.5  # Ждём дольше, чем таймаут теста (1 секунда)
    exit 0
else
    # Обычный режим для локального запуска
    echo "Мониторим текущий каталог. Ожидаем новый файл..."
    while true; do
        if [[ -f "fix.txt" ]]; then
            echo "Обнаружен файл: fix.txt"
            exit 0
        fi
        sleep 0.5  # Проверяем каждые 0.5 секунды
    done
fi
